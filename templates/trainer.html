<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Trainer (Read Only)</title>

    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" sizes="any">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon-64x364.png') }}" sizes="64x64">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon-64x64.png') }}">

    <style>
        body { font-family: sans-serif; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ccc; padding: 6px 10px; text-align: left; vertical-align: middle; }
        th { background: #f0f0f0; }
        .input-box { white-space: nowrap; }

        .user-block { margin-bottom: 35px; padding: 12px; border: 2px solid #ccc; }
        .user-heading { margin: 0 0 10px 0; }

        .loc-heading { margin: 10px 0 6px 0; }

        .label { font-weight: normal; margin-right: 4px; }

        html { visibility: hidden; }
    </style>

    <script>
        (function () {
            const TAB_KEY = "tab_ok_trainer";
            const LOGIN_URL = "{{ url_for('trainer_login') }}";

            if (!sessionStorage.getItem(TAB_KEY)) {
                window.location.replace(LOGIN_URL);
                return;
            }

            // Passed tab check â†’ allow page to render
            document.documentElement.style.visibility = "visible";
        })();
    </script>

</head>
<body>

<h1>Trainer (Read Only)</h1>
<p><a href="{{ url_for('index') }}">Back to main page</a></p>

{% if grouped_entries %}
{% for user_num, locs in grouped_entries.items() %}
<div class="user-block">

    <h2 class="user-heading">
        {% if user_num == 0 %}Unknown User{% else %}Crew Manager {{ user_num }}{% endif %}
    </h2>

    {# locs is an *ordered dict*: newest location first #}
    {% for loc, group in locs.items() %}
    <h3 class="loc-heading">
        <span class="label">Location:</span>{{ loc }}
    </h3>

    <table>
        <thead>
        <tr>
            <th>Timestamp (Central Time)</th>
            <th>Inputs</th>
            <th>Bus Capacities</th>
        </tr>
        </thead>
        <tbody>
        {# group is newest-first inside this location #}
        {% for e in group %}
        {% set inp = e.get("input") %}
        <tr>
            <td>{{ e.get("timestamp") }}</td>

            <td class="input-box">
                {% if not inp %}
                NULL
                {% elif inp is mapping %}
                <span class="label">Single Sites:</span>{{ inp.get("int1", "NULL") }}
                &nbsp;&nbsp;<span class="label">Double Sites:</span>{{ inp.get("int2", "NULL") }}
                &nbsp;&nbsp;<span class="label">Triple Sites:</span>{{ inp.get("int3", "NULL") }}
                &nbsp;&nbsp;<span class="label">Cars:</span>{{ inp.get("int4", "NULL") }}
                &nbsp;&nbsp;<span class="label">Vans:</span>{{ inp.get("int5", "NULL") }}
                {% else %}
                NULL
                {% endif %}
            </td>

            <td>
                {% if inp is mapping %}
                {% set buses = inp.get("int_list") %}
                {% if buses is none or buses == [] %}
                None
                {% else %}
                {{ buses }}
                {% endif %}
                {% else %}
                NULL
                {% endif %}
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
    {% endfor %}

</div>
{% endfor %}
{% else %}
<p>No entries logged yet.</p>
{% endif %}

<script>
    (function () {
        let tabId = sessionStorage.getItem("tab_id");
        if (!tabId) {
            tabId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : (Date.now() + "-" + Math.random());
            sessionStorage.setItem("tab_id", tabId);
        }

        fetch("/view_once", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ tab_id: tabId })
        }).catch(() => {});
    })();
</script>

</body>
</html>